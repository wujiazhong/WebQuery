<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<body>
		 <div class="col-md-offset-1 col-md-10 container" id="update_today_data">
		 	<br><br>
			<button class="btn btn-default col-md-offset-5 col-md-2 col-lg-2">手动更新数据表</button><br><br>
		 	<div class="panel panel-default">
			   <div class="panel-body">
			      	没有数据更新的信息！
			   </div>
			   <div class="panel-footer">共有 0 个表的数据被手动更新</div>
			</div>
		 </div>
		 <div class="col-md-offset-1 col-md-10 container" id="update_oper_time">
		 	<br><br>
		 	<div class="col-md-12">
			  	<label>选择井号： </label>
				<select class="selectpicker" id="jh_combobox"></select>
			</div>
			<div class="col-md-12 container">
				<div class="container col-md-6 col-lg-6" id="jl_date">
					<div class="container col-md-12 table_div">
						<table id="jl_date_table" class="display" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th>井号</th>
									<th>结蜡日期</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
						<br>
						<div class="table_btn_group">
							<button id="jl_add_btn" class="btn btn-default" data-toggle="modal" data-target="#add_row">增加</button>
			                <button id="jl_edit_btn" class="btn btn-default" data-toggle="modal" data-target="#edit_row">
			                	编辑
			                </button>
			                <button id="jl_del_btn" class="btn btn-default" data-toggle="modal" data-target="#del_row">删除</button>
			                <button id="jl_submit_btn" class="btn btn-default" data-toggle="modal" data-target="#submit_row">确定</button>
						</div>
					</div>
				</div>
					
				<div class="container col-md-6 col-lg-6" id="xj_date">
					<div class="container col-md-12 table_div">
						<table id="xj_date_table" class="display" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th>井号</th>
									<th>洗井日期</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
						<br>
						<div class="table_btn_group">
							<button id="xj_add_btn" class="btn btn-default" data-toggle="modal" data-target="#add_row">增加</button>
			                <button id="xj_edit_btn" class="btn btn-default" data-toggle="modal" data-target="#edit_row">
			                	编辑
			                </button>
			                <button id="xj_del_btn" class="btn btn-default" data-toggle="modal" data-target="#del_row">删除</button>
			                <button id="xj_submit_btn" class="btn btn-default" data-toggle="modal" data-target="#submit_row">确定</button>
		        		</div>
		        	</div>
				</div>
				
				<!-- 模态框（Modal） -->
				<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				   <div class="modal-dialog">
				      <div class="modal-content">
				         <div class="modal-header">
				            <button type="button" class="close" data-dismiss="modal"aria-hidden="true">×</button>
				            <h4 class="modal-title" id="myModalLabel"></h4>
				         </div>
				         <div class="modal-body"></div>
				         <div class="modal-footer">
				            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				            <button type="button" class="btn btn-primary modal_submit_btn">提交</button>
				         </div>
				      </div><!-- /.modal-content -->
				   </div><!-- /.modal-dialog -->
				</div><!-- /.modal -->
		 	</div>
		 </div>

		<script type="text/javascript" src="./js/jquery.js"></script>
		<script type="text/javascript" src="./datatable/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
  		<script type="text/javascript" src="./js/jquery.cookie.js"></script>
  		<script type="text/javascript" src="js/method.js"></script>
  		<script type="text/javascript">
  			$(document).ready(function(){  
  				/*
  				 *This class used to stands for date data recorded in two tables
  				 *@ version
  				 *@ author
  				 */				  				
  				function jhOperDateObj(jh){
  					this.jh = jh;
  					this.jl_list = new Array();
  					this.xj_list = new Array();
  				}
  				
  				jhOperDateObj.prototype = {
  					addItem: function(oper_type, content, isNew){
  						if(oper_type=="jl"){
  							this.jl_list.push({date:content,status:isNew});
  						}else if(oper_type=="xj"){
  							this.xj_list.push({date:content,status:isNew});
  						}
  					},
  					
  					editDate: function(oper_type, src_date, des_date){
  						if(oper_type=="jl"){
  							$.each(this.jl_list, function(key,val){
  								if(val.date == src_date){
  									val.date = des_date;
  									val.status = true;
  								}
  							});
  						}else if(oper_type=="xj"){
  							$.each(this.xj_list, function(key,val){
  								if(val.date == src_date){
  									val.date = des_date;
  									val.status = true;
  								}
  							});
  						}
  					}
  				}//jhOperDateObj end
  				
  				$.fn.createTableHead = function(){
					var $jh_th = $("<th>").text("井号");
					var $jl_date_th = $("<th>").text("结蜡日期");
					var $isNew_th = $("<th>").text("isNewData");
					var $new_tr = $("<tr>").append($jh_th).append($jl_date_th).append($isNew_th);
					var $new_thead = $("<thead>").append($new_tr);
					$(this).append($new_thead);
  				}
  				
  				$.fn.updateTable = function(info, table_name){
  					
  					var table_id = $(this).attr("id");
  					$("#"+table_id+" tbody").empty(); 
  					var list = [];
   					if(table_name == "jl"){
   						list = info.jl_list;
   					}else if(table_name == "xj"){
   						list = info.xj_list;
   					}
   					var cur_jh = info.jh;
   					//$("#"+table_id).createTableHead();
  					$.each(list, function(index, val){
       					var $new_jh_td = $("<td>").text(cur_jh);
       					var $new_jl_td = $("<td>").text($.trim(val.date));
       					//var $new_status_td = $("<td>").text(val.status)
       					$("<tr>").append($new_jh_td).append($new_jl_td).appendTo($("#"+table_id+" tbody"));
  					}); 
  					
		  			$("#"+table_id).dataTable({
		  				"searching": false,
		  				"bInfo":false,
		  				"bPaginate": false,
		  				"bRetrieve": true
		  			}); 				
  				}
  				
				$.fn.selectSingleRow = function(){
  					var table_id = $(this).attr("id");
	  				$("#"+table_id+" tbody").on("click", "tr",function (){
				        if ($(this).hasClass("selected")) {
				            $(this).removeClass("selected");
				        }
				        else {
				            $("#"+table_id+" tbody tr.selected").removeClass("selected");
				            $(this).addClass("selected");
				        }	  	
				    });			
	  			}
		  				
  				$.fn.editTableRowClick = function(action_abbr,action_name, table_id, input_id,table_info_list){
  					$(this).on("click", function(){ 
	  					var $selected_row =  $("#"+table_id+" tbody tr.selected");
	  					var cur_jh = $("#jh_combobox").find("option:selected").text();

				    	if(!$selected_row.length){
				    		alert("请在表格中选择要编辑的行！");
				    		return false;
				    	}
				    	
	  					$(".modal-body").empty();
	  					$("#myModalLabel").text("修正"+action_name+"日期");
	  					
	  					var $jh_label = $("<label>").text("原"+$("#"+table_id+" th").eq(0).text()).css("margin-right","10px").css("width","100px");
	  					//var $jh_input = $("<input>").val($selected_row.children("td").eq(0).text()).attr("disabled","true");
	  					var $jh_input = $("<input>").val(cur_jh).attr("disabled","true");
	  					var $jh_div = $("<div>").append($jh_label).append($jh_input);
	  					
	  					var $date_label = $("<label>").text($("#"+table_id+" th").eq(1).text()).css("margin-right","10px").css("width","100px");
				    	var $date_input = $("<input>").val($selected_row.children("td").eq(1).text()).attr("disabled","true");
				    	var $date_div = $("<div>").append($date_label).append($date_input);
				    	
				    	var $fix_date_label = $("<label>").text("修正"+action_name+"日期").css("margin-right","10px").css("width","100px");
				    	var $fix_date_input = $("<input placeholder='填写新的日期'>").attr("id",input_id.fix_date);
				    	var $fix_date_div = $("<div>").append($fix_date_label).append($fix_date_input);
				    	
				    	var $tip = $("<div>").text("*注意：修正日期的格式必须是yyyy-mm-dd，例如2015-03-02");
				    	
				    	$(".modal-body").append($jh_div).append($date_div).append($fix_date_div).append($tip);
				    	$(".modal-footer button[class*='modal_submit_btn']").remove();
				    	$("<button type='button' class='btn btn-primary modal_submit_btn' id='edit'>").text("提交").appendTo($(".modal-footer"));

				    	$(".modal").modal("show");
				    	$("#edit").on("click",function(){
				    		var input_text = $(".modal-body input[id='"+input_id.fix_date+"']").val();
					    	if(!checkDate(input_text)){
					    		return false;
					    	}
				    	
					    	var src_date = $selected_row.children("td").eq(1).text();
					    								    	
					    	$.each(table_info_list, function(index,val){
					    		if(val.jh == cur_jh){
					    			val.editDate(action_abbr,src_date,input_text);
					    			return false;
					    		}
					    	});
					    	
					    	$selected_row.children("td").eq(1).text(input_text);
					    	$(".modal").modal("hide");	
					    	$(".modal-body").empty();
				    	});
				    });
  				}
		  				
  				$.fn.addTableRowClick = function(action_abbr, action_name, table_id, input_id,table_info_list){
  					$(this).on("click", function(){ 
	  					$(".modal-body").empty();
	  					$("#myModalLabel").text("修正"+action_name+"日期");
	  					var cur_jh = $("#jh_combobox").find("option:selected").text();
	  					
	  					var $jh_label = $("<label>").text($("#"+table_id+" th").eq(0).text()).css("margin-right","10px").css("width","100px");
		  				//var $jh_input = $("<input>").attr("id", input_id.jh).attr("disabled","true");
		  				var $jh_input = $("<input>").val(cur_jh).attr("id", input_id.jh).attr("disabled","true");
		  				var $jh_div = $("<div>").append($jh_label).append($jh_input);
		  				
		  				var $date_label = $("<label>").text($("#"+table_id+" th").eq(1).text()).css("margin-right","10px").css("width","100px");
				    	var $date_input = $("<input>").attr("id", input_id.date);
				    	var $date_div = $("<div>").append($date_label).append($date_input);
				    	
				    	var $tip = $("<div>").text("*注意：1.请确保所填井队正确； 2.修正日期的格式必须是yyyy-mm-dd，例如2015-03-02");
				    	$(".modal-body").append($jh_div).append($jh_div).append($date_div).append($tip);
				    	$(".modal-footer button[class*='modal_submit_btn']").remove();
				    	$("<button type='button' class='btn btn-primary modal_submit_btn' id='add'>").text("提交").appendTo($(".modal-footer"));
					   	$(".modal").modal("show");
					   	$("#add").on("click",function(){
					   		var input_text = $(".modal-body input[id='"+input_id.date+"']").val();
					    	if(!checkDate(input_text)){
					    		return false;
					    	}
					    	var index = parseInt($("#"+table_id+" tbody tr").length) - 1;
					    	var $new_tr = $("<tr>")
					    							 
					    	$.each($(".modal-body").find("input"), function(key, val){
					    		var input_text = $(this).val();
					    		var $new_td = $("<td>").text(input_text).appendTo($new_tr);
					    	});
					    	
					    	$new_tr.insertAfter($("#"+table_id+" tbody").find("tr").eq(index));							    	
					    	$.each(table_info_list, function(index,val){
					    		if(val.jh == cur_jh){
					    			val.addItem(action_abbr,input_text,true);
					    			return false;
					    		}
					    	});
					    	
				  			$("#"+table_id).dataTable({
				  				"searching": false,
				  				"bInfo":false,
				  				"bPaginate": false,
				  				"bRetrieve": true
				  			});

					    	$(".modal").modal("hide");	
					    	$(".modal-body").empty();
					   	});
					});
  				}
		  				
		  		function getOperDateByWellName(well_name){
           			var oper_date = [];
           			$.each(well_info, function(index,val){
         				if(well_name == val.well_name){
         					oper_date = val;
         					return false;
         				}
         			});
           		}
  				
  				function checkDate(date){
  					var isRightDate = true;
  					var reg = /^\d{4}(-\d{2}){2}$/;
  					isRightDate = reg.test(date);
 					console.log(isRightDate);
 					
				    var ds=date.match(/\d+/g),ts=["getFullYear","getMonth","getDate"];
				    var d=new Date(date.replace(/-/g,'/')),i=3;
				    ds[1]--; //Date class, month index form 0, eg. Jan==0, Oct==9
				    while(i--){
				    	if( ds[i]*1!=d[ts[i]]()){
				    		isRightDate = false;
				    	}
				    }
				    if(!isRightDate){
				    	alert("所填写的修正日期错误或格式不符合要求，请检查！"); 
				    }

				    return isRightDate;
			    }
  				
  				$.ajax({
    			  type: "post",
                  url:  "GetWellOperDate_do",
                  data: {"userteam": $.cookie("userteam")},
                  dataType: "json",
                  success: function(data){
                        if(data.length == 0){
                        	alert("数据库中没有该井队的结蜡或洗井数据！");
                        	return false;
                        }	  	
                                          		                  		
                  		var well_info = data;
                  		var jh_list = [];
                  		var table_info_list = new Array();
               			$.each(well_info, function(index,val){
               				var table_item = new jhOperDateObj(val.well_name);
               				jh_list.push(val.well_name);
               				
               				var jl_list = [];
               				if(val.jl_date){
               					jl_list = val.jl_date.split(",");
               				}else{
               					jl_list = ["N/A"];
               				}
               				
               				$.each(jl_list, function(index,val){
                  				table_item.addItem("jl", val, false);
                  			});
                  			
                  			var xj_list = [];
               				if(val.xj_date){
               					xj_list = val.xj_date.split(",");
               				}else{
               					xj_list = ["N/A"];
               				}
                  			$.each(xj_list, function(index,val){
                  				table_item.addItem("xj", val, false);
                  			});
                  			table_info_list.push(table_item);
               			});

                  		initSelectMenu(jh_list, "jh_combobox");                  		
                  		   
                  		$("#jh_combobox").change(function(event){
                  			var cur_jh = $("#jh_combobox").find("option:selected").text();
                  			
                  			$.each(table_info_list, function(index,val){
                  				if(val.jh == cur_jh){
                  					$("#jl_date_table").updateTable(val,"jl");
                  					$("#xj_date_table").updateTable(val,"xj"); 
                  					return false;
                  				}	
                  			});
                  		});
                  		
                  		$("#jh_combobox").trigger("change");   			
		  					  				
			  			//set jl_date_table single select
			  			function input(jh,date,fix_date){
			  				this.jh = jh;
			  				this.date = date;
			  				this.fix_date = fix_date;
			  			}
			  			var jl_input_id = new input("jh","jl_date","jl_fix_date");
			  			$("#jl_date_table").selectSingleRow();
			  			$("#jl_date button[id='jl_edit_btn']").editTableRowClick("jl","结蜡","jl_date_table", jl_input_id,table_info_list);
			  			$("#jl_date button[id='jl_add_btn']").addTableRowClick("jl","结蜡","jl_date_table",jl_input_id,table_info_list);	
						
						var xj_input_id = new input("jh","xj_date","xj_fix_date");
			  			$("#xj_date_table").selectSingleRow();
			  			$("#xj_date button[id='xj_edit_btn']").editTableRowClick("xj","洗井","xj_date_table", xj_input_id,table_info_list);
			  			$("#xj_date button[id='xj_add_btn']").addTableRowClick("xj","洗井","xj_date_table",xj_input_id,table_info_list);
			  		},
			  		error: function(){
			  			alert("向数据库请求数据失败！");
                  	}
            	});		
			}); 
  		</script>
	</body>
</html>